#Amazon Web Services Set Up
The setup we decided to go with for the aws sandbox is with the site in EC2 and the wp database in RDS. The benefit of this being that the site will handle an infulx in visitors better, run a little faster, and has a bunch of amazon services for backing up and maintaining the database.

**NOTE**: If you are trying to connect to an existing EC2 Instance, Key Pair .pem files can be found in Web Communications/Key Pairs.

The stack for the sandbox is Linux, Apache2, PHP, MySQL, and WordPress 
- [Sandbox common_3.5_Home on AWS](http://ec2-54-213-144-58.us-west-2.compute.amazonaws.com/wordpress/)
- [Sandbox common_3.5 on AWS](http://ec2-54-213-144-58.us-west-2.compute.amazonaws.com/wordpress/engineering/) 

##New User Setup and Login Process
Before new users are allowed to touch AWS, they need their own account, to be assigned to a group,
and a key pair for accessing EC2 instances through SSH. The steps below detail how to get new users
set up. For more information, see http://aws.amazon.com/documentation/.

1. Create a new user wthin IAM (Identity and Access Management)
2. Add user to respective group
3. Create user password
4. Have user login from https://792190268398.signin.aws.amazon.com/console/

Users should always login from the aforementioned URL. Our root AWS user account should
be used sparingly, if at all.
 
##EC2 set up
Creating a new EC2 instance requires a key pair in order to access the instance
through SSH, FTP, etc. If a user has a .pem file for an existing key pair, that
.pem file can be used to acces the instance. Otherwise the user will need to create
a key pair and use the automatically generated .pem file to acces the instance.

A new key pair can be generated by going to EC2 > Network & Security > Key Pairs.

**NOTE**: Make sure HTTP (Port 80) is open on step 6 of creating a new EC2 instance to allow
for FTP connections.

1. Navigate to the EC2 Dashboard and click the Launch Instance button
2. Select a server, preferably Ubuntu or Amazon Linux
3. Select an instance type. If you don't know which to select, stick with the default
4. Configure instance details. Again, stick with the default settings if unsure of what to do
5. (Optional) Add storage
6. Tag the instance. At the least, indicate who the instance owner is and which stack the instance belongs to (e.g. Development, Testing, or Production)
7. Configure security group. Only create a custom security group if absolutely necessary, otherwise use a preexisting one best suited for your instance
8. Choose a key pair. See above for determining which option to select

After creating an instance, navigate to the EC2 Dashboard > Instances > Instances and click on the instance you have just created. Edit the name field if necessary
and then proceed to give the instance an elastic IP.

1. Look under the Description tab at the bottom of the page after clicking on the instance
2. In the right column, click the dash (-) next to Elastic IP
3. Allocate a new address if necessary, otherwise select an existing but unassociated address
4. Click Associate Address at the top and select your instance's name in the resulting modal
5. Click Associate

##Accessing an EC2 Instance (SSH)
To access an EC2 instance through SSH from the terminal, make sure you have the correct key pair .pem file
downloaded and in the current directory. It may be needed to run the following command if you are having trouble connecting:

`chmod 400 your-keypair-file.pem`

To connect, simply run this command if you are connecting to an Ubuntu instance:

`ssh -i your-keypair-file.pem ubuntu@public-DNS-of-instance`

If you are not connecting to an ubuntu instance, change ubuntu in the command above to ec2-user.

Once connected, you can access live files using the following command.

`cd /var/www/`

##Accessing an EC2 Instance (SFTP)
1. Download Filezilla if you do not have it already
2. Edit (Preferences) > Settings > Connection > SFTP, Click "Add key fileâ€
3. Browse to the location of your .pem file and select it.
4. A message box will appear asking your permission to convert the file into ppk format. Click Yes, then give the file a name and store it somewhere.
   If the new file is shown in the list of Keyfiles, then continue to the next step. If not, then click "Add keyfile..." and select the converted file.
   File > Site Manager Add a new site with the following parameters:

   **Host**: Your public dns name of ec2 instance, or the public ip address of the server

   **Protocol**: SFTP

   **Logon Type**: Normal

   **User**: From the docs: "For Amazon Linux, the default user name is ec2-user. For RHEL5, the user name is often root but might be ec2-user. For Ubuntu, the user name is ubuntu. For SUSE Linux, the user name is root. Otherwise, check with your AMI provider."

5. Press Connect Button - If saving of passwords has been disabled, you will be prompted that the logon type will be changed to 'Ask for password'.
   Say 'OK' and when connecting, at the password prompt push 'OK' without entering a password to proceed past the dialog.

**NOTE**: FileZilla automatically figures out which key to use. You do not need to specify the key after importing it as described above.

##Setting up Apache, MySQL, and PHP
Before a WordPress site can get up and running, Apache, MySQL, and PHP must be installed.
To do so, SSH into the EC2 instance and run the following commands.

###Apache

`sudo apt-get update`
`sudo apt-get install apache2`

To make sure Apache is isnstalled and working, enter the Public DNS associated with the instance
in your web browser. You should see a default landing page.

###MySQL
`sudo apt-get install mysql-server libapache2-mod-auth-mysql php5-mysql`

Then activate it with the following command.

`sudo mysql_install_db`

Finally, run the setup script.

`sudo /usr/bin/mysql_secure_installation`

This script will ask you to set a root password, but just leave that blank for now. It is easy to come
back and create a root password later. Then you will be walked through a series of questions, all to which you should
answer yes.

###PHP
`sudo apt-get install php5 libapache2-mod-php5 php5-mcrypt`

Also, add PHP to the directory index.

`sudo nano /etc/apache2/mods-enabled/dir.conf`

Edit the file so it lookes like this.

```
<IfModule mod_dir.c>
	DirectoryIndex index.php index.html index.cgi index.pl index.php index.xhtml index.htm
</IfModule>
```

##RDS set up
1. Click the Launch a DB Instance button on the RDS Dashboard homepage
2. Select MySQL
3. Give the database a name, admin username, and password
4. Choose database security group and tweak any settings if necessary. Make sure the chosen security group has port 3306 open
5. Click Launch DB Instance

To connect to the database, SSH into the associated EC2 instance and run the following command.

`sudo mysql -u username -p -h endpoint_name`

##Setting up WordPress
- The WP site will sit on EC2 and reference a database on RDS
- First set up your wordpress database, wp user, and grant priveleges in MySQL on your RDS server 
- Next install wordpress on your EC2 server (here is a [tutorial](https://www.digitalocean.com/community/tutorials/how-to-install-wordpress-on-centos-6--2) you can skip the steps for setting up the WP database since that should have already been done on the RDS instance) 
- **Important**: In wp-config make sure to change localhost to the RDS Endpoint! This is how you connect EC2 and RDS (use the same database and user info you just set up in RDS for the config) 

**Configure WP MultiSite** 
- [Here is a tutorial](https://www.digitalocean.com/community/tutorials/how-to-set-up-multiple-wordpress-sites-using-multisite) for multisite config
- Basically enable the wp network then update the config and .htaccess 
- You may need to change the apache config settings to allow for changes to htaccess. To do so change the AllowOverride to All in /etc/httpd/conf/httpd.conf (if you're on an ubuntu machine httpd will be apache2)
```
<Directory "/var/www/html">
	# note you still need the other settings. This is just to show what line to change 
	AllowOverride ALL
</Directory>
```
- Restart the server and you're good to go 


 
